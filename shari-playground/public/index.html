<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>shari playground</title>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.38.0/min/vs/loader.js"></script>
    <style>
        /* 全体のリセット */
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }

        /* 画面を左右に2分割するためのコンテナ */
        #container {
            display: flex;
            width: 100%;
            height: 100vh;
            /* 画面の高さいっぱい */
            overflow: hidden;
            /* はみ出し防止 */
        }

        /* 左カラム: Editor を縦いっぱいに広げる */
        #editor-container {
            flex: 1;
            /* 画面の半分を使う */
            border-right: 1px solid #ccc;
            display: flex;
            /* 内部要素をflexで配置 */
            flex-direction: column;
            /* 縦方向に要素を並べる */
        }

        /* Monaco Editor本体を高さいっぱいにする */
        #editor {
            flex: 1;
            /* 親の縦方向サイズをフルに使う */
        }

        /* 右ペイン: 縦に上下分割 */
        #output-container {
            flex: 1;
            /* 残りを全て使う */
            display: flex;
            flex-direction: column;
            /* 上下に並べる */
            gap: 5px;
            /* 上下の隙間 */
            padding: 5px;
        }

        /* 上部: 処理結果の表示領域 */
        #output {
            flex: 1;
            /* 上下で均等に分割したければ共にflex:1 */
            border: 1px solid #ccc;
            overflow: auto;
            padding: 0.5em;
            white-space: pre-wrap;
            font-family: "Courier New", Courier, monospace;
            /* 等幅フォント例 */
        }

        /* 下部: ログ用 textarea */
        #log-area {
            flex: 1;
            resize: none;
            /* ユーザーの手動リサイズを禁止 (任意) */
            border: 1px solid #ccc;
            font-family: "Courier New", Courier, monospace;
            padding: 0.5em;
            overflow: auto;
        }
    </style>
</head>

<body>
    <div id="container">
        <!-- 左カラム: Editor -->
        <div id="editor-container">
            <div id="editor"></div>
        </div>

        <!-- 右カラム: Runボタン + 出力 -->
        <div id="output-container">
            <div id="output"></div>
            <textarea id="log-area" readonly></textarea>
        </div>
    </div>

    <script>
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.38.0/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            fetch('./main.shari')
                .then(res => res.text())
                .then(text => {
                    window.editor = monaco.editor.create(document.getElementById('editor'), {
                        value: text,
                        language: 'plaintext',
                        theme: 'vs-light',
                        minimap: {
                            enabled: false
                        }
                    });
                })
                .catch(err => {
                    console.error('Default file load error:', err);
                    window.editor = monaco.editor.create(document.getElementById('editor'), {
                        value: '-- Fallback content',
                        language: 'plaintext',
                        theme: 'vs-light'
                    });
                });
        });
    </script>

    <script type="module">
        import init, { init_logger, run_process } from "./shari_playground.js";

        const logArea = document.getElementById("log-area");

        window.appendLog = function (msg) {
            logArea.value += msg + "\n";
        };

        let autoRunTimer = null;

        async function main() {
            await init();
            init_logger();

            const output = document.getElementById("output");

            function runCode() {
                // TODO: ログはクリアしないほうがいいかも？
                logArea.value = "";
                const inputCode = window.editor.getValue();
                const result = run_process(inputCode);
                output.textContent = result;
            }

            // Monaco Editor が作成完了するまでタイミングを待つため少し工夫
            // (editor がすぐには存在しないことがある)
            const checkEditor = () => {
                // editor が存在しても onDidChangeModelContent が undefined になっていることがある。原因不明。
                if (window.editor && window.editor.onDidChangeModelContent) {
                    // エディタのモデルが変更されるたびに実行
                    window.editor.onDidChangeModelContent(() => {
                        // 打鍵の最終入力から 500ms 待って自動実行
                        clearTimeout(autoRunTimer);
                        autoRunTimer = setTimeout(() => {
                            runCode();
                        }, 500);
                    });

                    runCode(); // 初回実行
                } else {
                    setTimeout(checkEditor, 200); // editor がまだ準備できていなければ再試行
                }
            };
            checkEditor();
        }

        main();
    </script>
</body>

</html>